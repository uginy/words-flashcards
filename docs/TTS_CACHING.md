# TTS Кеширование

Система TTS (Text-to-Speech) поддерживает автоматическое кеширование синтезированного аудио для улучшения производительности и снижения нагрузки на внешние API.

## Возможности

### ✅ Что реализовано
- ✅ Автоматическое кеширование для аудио провайдеров (Microsoft TTS)
- ✅ Уникальные ключи кеша на основе текста, опций и провайдера
- ✅ Быстрое воспроизведение из кеша
- ✅ Управление кешем (очистка, статистика)
- ✅ Автоматическая очистка устаревших записей
- ✅ Настройка включения/выключения через конфигурацию

### ❌ Ограничения
- ❌ Системный TTS не кешируется (не поддерживает аудио буферы)
- ❌ Кеш хранится только в памяти (теряется при перезагрузке)

## Принцип работы

### Алгоритм кеширования

1. **Генерация ключа кеша**: Создается уникальный ключ на основе:
   ```typescript
   const cacheKey = `${provider}-${text}-${btoa(JSON.stringify(options))}`;
   ```

2. **Проверка кеша**: Перед синтезом проверяется наличие записи в кеше

3. **Синтез и кеширование**: Если кеша нет - синтезируется аудио и сохраняется

4. **Воспроизведение**: Аудио воспроизводится из кеша или только что синтезированное

### Структура записи кеша

```typescript
interface TTSCacheEntry {
  audioData: ArrayBuffer;    // Аудио данные в формате MP3
  timestamp: number;         // Время создания записи
  provider: TTSProviderType; // Провайдер, создавший запись
}
```

## Конфигурация

### Включение/выключение кеширования

```typescript
import { getTTSManager } from './src/services/tts';

const ttsManager = getTTSManager();

// Включить кеширование (по умолчанию включено)
ttsManager.updateConfig({
  cacheEnabled: true
});

// Выключить кеширование
ttsManager.updateConfig({
  cacheEnabled: false
});
```

### Настройка провайдера

```typescript
// Настройка Microsoft TTS для поддержки кеширования
ttsManager.updateConfig({
  provider: 'microsoft',
  microsoftApiKey: 'ваш-ключ-api',
  microsoftRegion: 'westeurope',
  cacheEnabled: true
});
```

## Управление кешем

### Получение статистики

```typescript
const stats = ttsManager.getCacheStats();
console.log(`Записей в кеше: ${stats.size}`);
console.log('Записи:', stats.entries);
```

### Очистка кеша

```typescript
// Полная очистка
ttsManager.clearCache();

// Очистка устаревших записей (старше 24 часов)
const removedCount = ttsManager.clearExpiredCache();

// Очистка записей старше 1 часа
const removedCount = ttsManager.clearExpiredCache(60 * 60 * 1000);
```

## Производительность

### Ожидаемые улучшения
- **Первый синтез**: 500-2000ms (зависит от API)
- **Повторный синтез**: 10-50ms (из кеша)
- **Улучшение**: 90-95% снижение времени

### Пример использования

```typescript
const text = 'שלום עולם!';
const options = { lang: 'he-IL', rate: 1.0 };

// Первый вызов - синтез + кеширование
await ttsManager.speak(text, options); // ~1000ms

// Второй вызов - из кеша
await ttsManager.speak(text, options); // ~20ms
```

## Тестирование

Запустите тестовый скрипт для проверки кеширования:

```bash
bun run scripts/test-tts-caching.ts
```

Тест покажет:
- Время первого синтеза
- Время повторного воспроизведения из кеша
- Статистику кеша
- Управление кешем

## Технические детали

### Ключи кеша

Формат ключа: `{provider}-{text}-{base64(options)}`

Пример:
```
microsoft-שלום עולם!-eyJsYW5nIjoiaGUtSUwiLCJyYXRlIjoxLjB9
```

### Автоматическая очистка

- При запуске системы удаляются записи старше 24 часов
- При смене провайдера весь кеш очищается
- Можно настроить периодическую очистку

### Обработка ошибок

- Ошибки кеша не влияют на основную функциональность
- При проблемах с кешем происходит обычный синтез
- Логирование проблем для отладки

## Рекомендации

1. **Включайте кеширование** для лучшей производительности
2. **Настройте Microsoft TTS** для максимальной пользы от кеширования
3. **Периодически очищайте кеш** для экономии памяти
4. **Мониторьте размер кеша** в продакшене

## Будущие улучшения

- [ ] Постоянное хранение кеша (localStorage/IndexedDB)
- [ ] Сжатие аудио данных в кеше
- [ ] Ограничение размера кеша
- [ ] Предзагрузка часто используемых фраз
- [ ] Кеширование для других провайдеров